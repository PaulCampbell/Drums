var Flailr=function(){function c(e){for(var t=0;t<e.hitTargets.length;t++){var n=document.createElement("img");e.hitTargets[t].id&&(n.id=e.hitTargets[t].id),e.hitTargets[t].graphic&&n.setAttribute("src",e.hitTargets[t].graphic),n.setAttribute("style","position: absolute; left: "+e.hitTargets[t].x+"px; top: "+e.hitTargets[t].y+"px; width:"+e.hitTargets[t].width+"px;  height:"+e.hitTargets[t].height+"px;"),e.hitTargets[t].showOutline&&n.setAttribute("style","border:solid 1px red; "+n.getAttribute("style")),console.log("adding "+n),a.appendChild(n)}h(e)}function h(e){e.showVideo||(document.getElementById("canvas-source").style.opacity="0"),p(e)}function p(e){d(),v(),w(e),o=setTimeout(function(){p(e)},1e3/60)}function d(){i.drawImage(n,0,0,n.width,n.height)}function v(){var e=t.width,n=t.height,r=i.getImageData(0,0,e,n);u||(u=i.getImageData(0,0,e,n));var o=i.createImageData(e,n);y(o.data,r.data,u.data),s.putImageData(o,0,0),u=r}function m(e){return(e^e>>31)-(e>>31)}function g(e){return e>21?255:0}function y(e,t,n){if(t.length!=n.length)return null;var r=0;while(r<t.length*.25){var i=(t[4*r]+t[4*r+1]+t[4*r+2])/3,s=(n[4*r]+n[4*r+1]+n[4*r+2])/3,o=g(m(i-s));e[4*r]=o,e[4*r+1]=o,e[4*r+2]=o,e[4*r+3]=255,++r}}function b(e,t){var n=[];for(var r=0;r<f.length;++r){f[r].type==e&&n.push(f[r]);for(var i=0;i<n.length;++i)n[i].listener(t)}}function w(e){for(var t=0;t<e.hitTargets.length;++t){var n=s.getImageData(e.hitTargets[t].x,e.hitTargets[t].y,e.hitTargets[t].width,e.hitTargets[t].height),r=0,i=0;while(r<n.data.length*.25)i+=(n.data[r*4]+n.data[r*4+1]+n.data[r*4+2])/3,++r;i=Math.round(i/(n.data.length*.25)),i>e.sensitivity&&b("targetHit",{vigour:i,hitTarget:e.hitTargets[t]})}}var e={},t,n,r,i,s,o,u,a;e.width=640,e.height=480,e.containerId="",e.hitTargets=[],e.sensitivity=60,e.showVideo=!0,e.showDifferenceCanvas=!1,e.addEventListener=function(e,t){f.push({type:e,listener:t})};var f=[];e.start=function(){var o=this;a=document.getElementById(e.containerId),a||(a=document.getElementsByTagName("body")[0]),n=document.createElement("video"),n.id="webcam",n.setAttribute("width",o.width.toString()),n.setAttribute("autoplay","autoplay"),n.setAttribute("height",o.height.toString()),n.setAttribute("style","display:none;"),a.appendChild(n),t=document.createElement("canvas"),t.setAttribute("width",o.width.toString()),t.setAttribute("height",o.height.toString()),t.id="canvas-source",a.appendChild(t),r=document.createElement("canvas"),r.setAttribute("width",o.width.toString()),r.setAttribute("height",o.height.toString()),r.id="canvas-blended",r.setAttribute("style","display:none;"),a.appendChild(r),t=document.getElementById("canvas-source"),r=document.getElementById("canvas-blended"),i=t.getContext("2d"),s=r.getContext("2d"),i.translate(t.width,0),i.scale(-1,1),navigator.getUserMedia?navigator.getUserMedia({audio:!1,video:!0},function(e){n.src=e,c(o)},l):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia({audio:!1,video:!0},function(e){n.src=window.webkitURL.createObjectURL(e),c(o)},l):alert("browser does not support getUserMedia")};return e;var l};