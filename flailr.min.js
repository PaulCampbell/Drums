var Flailr=function(){function c(e,t){e.hitTargets[t].ready=!1;var n=document.createElement("img");return e.hitTargets[t].id&&(n.id=e.hitTargets[t].id),e.hitTargets[t].graphic&&n.setAttribute("src",e.hitTargets[t].graphic),n.setAttribute("style","position: absolute; left: "+e.hitTargets[t].x+"px; top: "+e.hitTargets[t].y+"px; width:"+e.hitTargets[t].width+"px;  height:"+e.hitTargets[t].height+"px;"),e.hitTargets[t].showOutline&&n.setAttribute("style","border:solid 1px red; "+n.getAttribute("style")),a.appendChild(n),S(e,e.hitTargets[t],500),n}function h(e){p(e);for(var t=0;t<e.hitTargets.length;t++)c(e,t)}function p(e){e.showVideo||(document.getElementById("canvas-source").style.opacity="0"),e.showDifferenceCanvas&&document.getElementById("canvas-blended").setAttribute("style",""),d(e)}function d(e){v(),m(),E(e),o=setTimeout(function(){d(e)},1e3/60)}function v(){i.drawImage(n,0,0,n.width,n.height)}function m(){var e=t.width,n=t.height,r=i.getImageData(0,0,e,n);u||(u=i.getImageData(0,0,e,n));var o=i.createImageData(e,n);b(o.data,r.data,u.data),s.putImageData(o,0,0),u=r}function g(e){return(e^e>>31)-(e>>31)}function y(e){return e>21?255:0}function b(e,t,n){if(t.length!=n.length)return null;var r=0;while(r<t.length*.25){var i=(t[4*r]+t[4*r+1]+t[4*r+2])/3,s=(n[4*r]+n[4*r+1]+n[4*r+2])/3,o=y(g(i-s));e[4*r]=o,e[4*r+1]=o,e[4*r+2]=o,e[4*r+3]=255,++r}}function w(e,t){var n=[];for(var r=0;r<f.length;++r){f[r].type==e&&n.push(f[r]);for(var i=0;i<n.length;++i)n[i].listener(t)}}function E(e){for(var t=0;t<e.hitTargets.length;++t){var n=s.getImageData(e.hitTargets[t].x,e.hitTargets[t].y,e.hitTargets[t].width,e.hitTargets[t].height),r=0,i=0;while(r<n.data.length*.25)i+=(n.data[r*4]+n.data[r*4+1]+n.data[r*4+2])/3,++r;i=Math.round(i/(n.data.length*.25)),i>e.sensitivity&&e.hitTargets[t].ready&&(w("targetHit",{vigour:i,hitTarget:e.hitTargets[t]}),e.hitTargets[t].ready=!1,S(e,e.hitTargets[t]))}}function S(e,t,n){var r=1e3*(1/e.maxHitsPerSecond);n&&(r=n),setTimeout(function(){t.ready=!0},r)}var e={},t,n,r,i,s,o,u,a;e.width=640,e.height=480,e.containerId="",e.hitTargets=[],e.sensitivity=60,e.showVideo=!0,e.showDifferenceCanvas=!1,e.maxHitsPerSecond=10,e.addEventListener=function(e,t){f.push({type:e,listener:t})};var f=[];e.start=function(o){var u=this;a=document.getElementById(e.containerId),a||(a=document.getElementsByTagName("body")[0]),t=document.createElement("canvas"),t.setAttribute("width",u.width.toString()),t.setAttribute("height",u.height.toString()),t.id="canvas-source",a.appendChild(t),r=document.createElement("canvas"),r.setAttribute("width",u.width.toString()),r.setAttribute("height",u.height.toString()),r.id="canvas-blended",r.setAttribute("style","display:none;"),a.appendChild(r),t=document.getElementById("canvas-source"),r=document.getElementById("canvas-blended"),i=t.getContext("2d"),s=r.getContext("2d"),i.translate(t.width,0),i.scale(-1,1),o?(n=o,n.setAttribute("style","display:none;"),a.appendChild(n),h(u)):(n=document.createElement("video"),n.id="webcam",n.setAttribute("width",u.width.toString()),n.setAttribute("autoplay","autoplay"),n.setAttribute("height",u.height.toString()),n.setAttribute("style","display:none;"),a.appendChild(n),navigator.getUserMedia?navigator.getUserMedia({audio:!1,video:!0},function(e){n.src=e,h(u)},l):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia({audio:!1,video:!0},function(e){n.src=window.webkitURL.createObjectURL(e),h(u)},l):alert("browser does not support getUserMedia"))};return e;var l};